<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoL Rank Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+KR:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Inter', 'Noto Sans JP', 'Noto Sans KR', 'Noto Sans SC', sans-serif;
            background-color: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            color: #f8fafc;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Ç¶„Ç£„É≥„Éâ„Ç¶„É¢„Éº„ÉâÁî®„Çπ„Çø„Ç§„É´ */
        body.popup-window-mode {
            background: #0f172a; /* „Ç¶„Ç£„É≥„Éâ„Ç¶„Ç≠„É£„Éó„ÉÅ„É£Áî®„Å´ËÉåÊôØËâ≤„ÇíÁ¢∫‰øù */
            background-image: none;
            overflow: hidden !important; /* „Çπ„ÇØ„É≠„Éº„É´„Éê„ÉºÂÆåÂÖ®ÊäëÊ≠¢ */
        }
        
        body.popup-window-mode #app-scale-wrapper {
            display: none !important;
        }

        body.popup-window-mode #floatingPopup {
            display: flex !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            transform: none !important;
            border-radius: 0 !important;
            border: none !important;
            box-shadow: none !important;
            resize: none !important;
            z-index: 9999;
            min-width: 0 !important;
            min-height: 0 !important;
        }

        body.popup-window-mode #popupHeader {
            cursor: default; /* „Éâ„É©„ÉÉ„Ç∞‰∏çÂèØ„ÇíÁ§∫„Åô */
        }
        
        body.popup-window-mode .close-btn-icon {
            /* OBSÁî®„Å´„ÅØ‰∏çË¶Å„Å†„Åå„ÄÅ„Ç¶„Ç£„É≥„Éâ„Ç¶„ÇíÈñâ„Åò„Çã„Éú„Çø„É≥„Å®„Åó„Å¶Ê©üËÉΩ„Åï„Åõ„Çã„Åü„ÇÅË°®Á§∫„ÅØÁ∂≠ÊåÅ */
        }

        #app-scale-wrapper {
            width: 1280px;  
            height: 800px; 
            position: relative;
            transform-origin: center center;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.3);
        }

        #app-scroll-container {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #app-scroll-container::-webkit-scrollbar { width: 8px; }
        #app-scroll-container::-webkit-scrollbar-track { background: transparent; }
        #app-scroll-container::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        #app-scroll-container::-webkit-scrollbar-thumb:hover { background: #475569; }

        .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-input {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s;
        }
        .glass-input:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
            outline: none;
        }

        .history-chip {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0;
            padding-right: 0.5rem;
            padding-left: 0.25rem;
        }
        .history-chip:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.4);
        }
        
        .favorite-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            cursor: pointer;
            color: rgba(255,255,255,0.2);
            transition: all 0.2s;
        }
        .favorite-btn:hover {
            color: #fbbf24;
            transform: scale(1.1);
        }
        .favorite-btn.active {
            color: #fbbf24;
        }
        .favorite-btn svg {
            width: 14px;
            height: 14px;
        }

        .history-content {
            cursor: pointer;
            padding: 0.25rem 0.5rem 0.25rem 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .history-delete-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.5);
            cursor: pointer;
            font-size: 10px;
            line-height: 1;
            transition: all 0.2s;
        }
        .history-delete-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .rank-glow { text-shadow: 0 0 20px currentColor; }
        
        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        input[type="checkbox"] {
            accent-color: #3b82f6;
            width: 16px;
            height: 16px;
        }
        
        #floatingPopup {
            resize: both;
            overflow: hidden;
            min-width: 150px;
            min-height: 100px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            container-type: size;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        #floatingPopup.hidden { display: none; }
        
        #popupHeader {
            flex-shrink: 0; height: 32px; cursor: move;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 8px; background: rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            user-select: none;
        }

        #popupBody {
            flex-grow: 1; width: 100%; height: calc(100% - 32px);
            position: relative; overflow: hidden;
        }

        .cq-container { width: 100%; height: 100%; }

        /* ÈÄöÂ∏∏„É¢„Éº„Éâ„ÅÆ„É¨„Ç§„Ç¢„Ç¶„Éà */
        .layout-normal {
            display: flex; flex-direction: column; width: 100%; height: 100%;
            padding: 2cqh; box-sizing: border-box; align-items: center;
            justify-content: center;
        }
        .layout-normal .section-icon {
            flex: 0 0 40%; display: flex; align-items: center;
            justify-content: center; width: 100%; overflow: hidden; padding-bottom: 1cqh;
        }
        .layout-normal .cq-rank-icon {
            height: 100%; width: auto; max-width: 80%;
            object-fit: contain; filter: drop-shadow(0 0 15px rgba(0,0,0,0.5));
        }
        .layout-normal .section-info {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start; width: 100%;
            gap: 0.5cqh; padding-top: 0;
        }
        .layout-normal .cq-rank-text {
            font-size: 14cqh; width: 100%; text-align: center;
            white-space: nowrap; line-height: 1; font-weight: 900;
            text-shadow: 0 0 10px currentColor;
            margin-bottom: 0.5cqh;
        }
        .layout-normal .cq-lp-text { 
            font-size: 14cqh; line-height: 1; font-weight: 900;
            margin-bottom: 2cqh;
            text-shadow: 0 0 10px currentColor;
        }
        .layout-normal .cq-stats-group { display: flex; align-items: center; gap: 6cqw; }
        .layout-normal .cq-stat-item { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .layout-normal .cq-stat-label { font-size: 12cqh; margin-bottom: 0.5cqh; font-weight: bold; line-height: 1; }
        .layout-normal .cq-stat-value { font-size: 9cqh; font-weight: 800; line-height: 1; color: white; }

        /* LIVE„É¢„Éº„Éâ„ÅÆ„É¨„Ç§„Ç¢„Ç¶„Éà */
        .layout-live {
            display: flex; flex-direction: row; align-items: center;
            padding: 6px 16px; /* ‰ΩôË£ï„ÅÆ„ÅÇ„ÇãÈÄèÊòé„Å™Êû†Ôºà„Éë„Éá„Ç£„É≥„Ç∞Ôºâ */
            background: transparent; gap: 15px;
            height: 100%; width: 100%; box-sizing: border-box;
            justify-content: flex-start;
            border: 4px solid transparent; /* ÈÄèÊòé„Å™Êû†Ôºà„Éú„Éº„ÉÄ„ÉºÔºâ */
        }
        .layout-live .cq-rank-icon {
            height: 90cqh; width: auto; max-width: 25cqw;
            object-fit: contain; filter: drop-shadow(0 0 4px rgba(0,0,0,0.8));
            flex-shrink: 0;
        }
        .layout-live .cq-content {
            display: flex; flex-direction: column; justify-content: center;
            align-items: flex-start; height: 100%; flex-grow: 1;
            gap: 4cqh;
        }
        
        .layout-live .cq-rank-row {
            display: flex; flex-direction: row; align-items: baseline; gap: 10px;
        }
        .layout-live .cq-rank-text {
            font-size: 34cqh; font-weight: 900; white-space: nowrap;
            text-shadow: 0 0 10px currentColor; line-height: 1; text-align: left;
        }
        .layout-live .cq-lp-text { 
            font-size: 34cqh; font-weight: 900; line-height: 1;
            text-shadow: 0 0 10px currentColor;
        }

        .layout-live .cq-stats-row {
            display: flex; flex-direction: row; align-items: center; gap: 15px;
        }
        .layout-live .cq-stat-item { display: flex; align-items: center; gap: 4px; }
        .layout-live .cq-stat-label { font-size: 20cqh; opacity: 0.9; font-weight: bold; line-height: 1; }
        .layout-live .cq-stat-value { font-size: 20cqh; color: white; font-weight: 800; line-height: 1; }

        .layout-live .history-bar {
            display: flex; align-items: center; gap: 0;
            height: 16cqh; margin-left: 5px;
        }
        .layout-live .history-block {
            width: 8cqh; min-width: 2px; height: 100%; border-radius: 2px; opacity: 0.9;
        }
        .layout-live .history-spacer {
            width: 2cqh; height: 100%; background: transparent;
        }

        .block-win { background-color: #3b82f6; box-shadow: 0 0 2px rgba(59, 130, 246, 0.4); }
        .block-loss { background-color: #f87171; box-shadow: 0 0 2px rgba(248, 113, 113, 0.4); }

        .btn-live-toggle {
            font-size: 10px; padding: 3px 10px; background: #2563eb; color: white;
            border-radius: 4px; border: none; cursor: pointer; transition: all 0.2s;
            font-weight: bold; letter-spacing: 0.5px;
        }
        .btn-live-toggle:hover { background: #1d4ed8; }
        .btn-live-toggle.active-mode { background: #059669; }
        .btn-live-toggle.active-mode:hover { background: #047857; }

        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <div id="app-scale-wrapper">
        <div id="app-scroll-container">
            <header class="w-full glass-panel border-b border-white/10 sticky top-0 z-40">
                <div class="max-w-6xl mx-auto px-4 py-4 flex flex-row items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/20 shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                        </div>
                        <div class="flex flex-col">
                            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-200 via-blue-100 to-white leading-tight" data-i18n="appTitle">
                                LoL Rank Checker
                            </h1>
                            <p class="text-[10px] text-blue-300/80 font-medium tracking-wide uppercase leading-tight" data-i18n="appSubtitle">
                                Summoner Analytics
                            </p>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <select id="langSelect" onchange="changeLanguage()" class="bg-slate-800 text-xs text-slate-300 border border-slate-700 rounded-md px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
                            <option value="en">üá∫üá∏ English</option>
                            <option value="ko">üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
                            <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                        </select>
                    </div>
                </div>
            </header>

            <main class="flex-grow flex flex-col items-center p-4 pt-8 sm:pt-12 relative">
                <div class="w-full max-w-6xl flex flex-col lg:flex-row gap-8 items-start justify-center">
                    
                    <div class="w-full max-w-lg flex flex-col gap-6">
                        <div class="glass-panel p-6 rounded-2xl shadow-2xl relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-500"></div>
                            <div class="flex flex-col gap-4">
                                <div class="flex gap-2">
                                    <div class="w-2/3">
                                        <label class="block text-[10px] text-gray-400 mb-1 ml-1" data-i18n="lblGameName">Game Name</label>
                                        <input type="text" id="gameName" placeholder="Name" class="w-full glass-input rounded-lg px-4 py-2.5" data-i18n-placeholder="phGameName">
                                    </div>
                                    <div class="w-1/3">
                                        <label class="block text-[10px] text-gray-400 mb-1 ml-1" data-i18n="lblTagLine">Tag Line</label>
                                        <input type="text" id="tagLine" placeholder="#Tag" class="w-full glass-input rounded-lg px-4 py-2.5" data-i18n-placeholder="phTagLine">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-[10px] text-gray-400 mb-1 ml-1" data-i18n="lblRegion">Region</label>
                                    <select id="region" class="w-full glass-input rounded-lg px-4 py-2.5 appearance-none cursor-pointer">
                                        <option value="jp1" selected>Japan (JP)</option>
                                        <option value="na1">North America (NA)</option>
                                        <option value="euw1">Europe West (EUW)</option>
                                        <option value="kr">Korea (KR)</option>
                                    </select>
                                </div>
                                <div id="historyContainer" class="hidden">
                                    <label class="block text-[10px] text-gray-500 mb-1.5 ml-1" data-i18n="lblHistory">Recent Searches</label>
                                    <div id="historyList" class="flex flex-wrap gap-2 mb-2"></div>
                                </div>
                                <div class="flex flex-col gap-3 mt-2">
                                    <button onclick="startFetch()" id="searchBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition-all shadow-[0_0_20px_rgba(37,99,235,0.3)] hover:shadow-[0_0_30px_rgba(37,99,235,0.5)] active:scale-[0.98]">
                                        <span data-i18n="btnSearch">Fetch Stats</span>
                                    </button>
                                    <div class="flex items-center justify-between px-1">
                                        <label class="flex items-center gap-2 cursor-pointer group">
                                            <div class="relative flex items-center">
                                                <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()" class="peer sr-only">
                                                <div class="w-9 h-5 bg-slate-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                                            </div>
                                            <div class="flex flex-col">
                                                <span class="text-xs text-gray-400 group-hover:text-gray-300 transition-colors" data-i18n="lblAutoRefresh">Active Monitoring (10m)</span>
                                            </div>
                                            <span id="timerLabel" class="text-xs text-blue-400 font-mono ml-2 hidden"></span>
                                        </label>
                                        <button onclick="toggleFloatingPopup()" class="text-xs bg-slate-800 hover:bg-slate-700 text-blue-300 hover:text-white px-3 py-1.5 rounded border border-slate-700 transition-colors flex items-center gap-1.5">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg>
                                            <span data-i18n="btnPopup">Popup Monitor</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="fetchProgress" class="hidden glass-panel p-5 rounded-xl border-white/5">
                            <h3 class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-widest text-center" data-i18n="progressTitle">Analyzing Data</h3>
                            <div class="space-y-4">
                                <div id="step-account" class="flex items-center gap-3 text-gray-500 transition-colors duration-300">
                                    <div class="w-6 h-6 rounded-full border-2 border-current flex items-center justify-center text-[10px] status-icon opacity-50">1</div>
                                    <span class="text-sm font-medium" data-i18n="stepIdentity">Verify Identity (PUUID)</span>
                                </div>
                                <div id="step-league" class="flex items-center gap-3 text-gray-500 transition-colors duration-300">
                                    <div class="w-6 h-6 rounded-full border-2 border-current flex items-center justify-center text-[10px] status-icon opacity-50">2</div>
                                    <span class="text-sm font-medium" data-i18n="stepRank">Check Rank Tier & LP</span>
                                </div>
                                <div id="step-matches" class="flex items-center gap-3 text-gray-500 transition-colors duration-300">
                                    <div class="w-6 h-6 rounded-full border-2 border-current flex items-center justify-center text-[10px] status-icon opacity-50">3</div>
                                    <div class="flex flex-col">
                                        <span class="text-sm font-medium" data-i18n="stepMatches">Scan Last 20 Ranked Matches</span>
                                        <span id="matchCountLabel" class="text-[10px] text-blue-400 font-mono h-4"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="errorMsg" class="hidden p-4 bg-red-950/40 border border-red-500/50 text-red-200 rounded-lg text-sm text-center flex flex-col items-center gap-2 backdrop-blur-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                            <span id="errorText"></span>
                        </div>
                    </div>

                    <div id="resultArea" class="hidden w-full max-w-lg glass-panel p-8 rounded-2xl shadow-2xl text-center border-t border-white/10">
                        <div id="playerInfo" class="animate-fade-in-up">
                            <h2 id="displayName" class="text-3xl font-bold mb-1 text-white tracking-tight"></h2>
                            <div class="flex flex-col items-center mt-6">
                                <div id="rankIconContainer" class="relative mb-4">
                                    <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent blur-xl rounded-full"></div>
                                    <img id="rankIcon" src="png/Iron.png" class="relative w-48 h-48 object-contain drop-shadow-2xl transform hover:scale-110 transition-transform duration-300 select-none" alt="Rank Icon">
                                </div>
                                <div id="rankText" class="text-4xl font-black uppercase tracking-wider rank-glow mb-1"></div>
                                <div id="lpValue" class="text-4xl text-blue-200/80 font-mono bg-blue-900/20 px-4 py-2 rounded-full border border-blue-500/20"></div>
                                
                                <div class="mt-8 w-full bg-slate-900/50 rounded-xl p-4 border border-slate-700/50">
                                    <div class="text-[10px] text-slate-400 uppercase font-bold tracking-[0.2em] mb-4" data-i18n="lblRecentResults">Last 20 Matches</div>
                                    <div class="grid grid-cols-2 gap-4 divide-x divide-slate-700/50">
                                        <div class="flex flex-col items-center">
                                            <span class="text-[10px] text-blue-400 font-bold mb-1" data-i18n="lblWins">WINS</span>
                                            <span id="winCount" class="text-2xl font-black text-white">0</span>
                                        </div>
                                        <div class="flex flex-col items-center">
                                            <span class="text-[10px] text-rose-400 font-bold mb-1" data-i18n="lblLosses">LOSSES</span>
                                            <span id="lossCount" class="text-2xl font-black text-white">0</span>
                                        </div>
                                    </div>
                                </div>

                                <div id="seasonTotalSection" class="mt-4 w-full bg-slate-800/30 rounded-xl p-4 border border-slate-700/30">
                                    <div class="text-[10px] text-slate-400 uppercase font-bold tracking-[0.2em] mb-4" data-i18n="lblSeasonTotal">Season Total</div>
                                    <div class="grid grid-cols-3 gap-4 divide-x divide-slate-700/30">
                                        <div class="flex flex-col items-center">
                                            <span class="text-[10px] text-emerald-500/70 font-bold mb-1" data-i18n="lblWins">WINS</span>
                                            <span id="totalWinCount" class="text-xl font-bold text-gray-200">0</span>
                                        </div>
                                        <div class="flex flex-col items-center">
                                            <span class="text-[10px] text-rose-500/70 font-bold mb-1" data-i18n="lblLosses">LOSSES</span>
                                            <span id="totalLossCount" class="text-xl font-bold text-gray-200">0</span>
                                        </div>
                                        <div class="flex flex-col items-center justify-center">
                                            <span class="text-[10px] text-blue-500/70 font-bold mb-1" data-i18n="lblWinRate">WIN RATE</span>
                                            <span id="totalWinRatio" class="text-lg font-bold text-gray-300">0%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-2 text-[10px] text-gray-500" id="lastUpdatedLabel"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <footer class="mt-auto py-6 text-center text-[10px] text-gray-600">
                    <p data-i18n="footerText">Data provided by Riot Games API via Vercel Serverless Proxy.</p>
                </footer>
            </main>
        </div>
    </div>

    <!-- Draggable Popup (Shared with Popup Mode) -->
    <div id="floatingPopup" class="hidden fixed z-50 glass-panel rounded-xl" style="top: 100px; left: 50%; transform: translateX(-50%); width: 420px; height: 336px;">
        <div id="popupHeader">
            <div class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                </svg>
                <span class="text-[10px] font-bold text-gray-300 tracking-wider" data-i18n="popupTitle">RANK MONITOR</span>
            </div>
            <div class="flex items-center gap-2">
                <button id="modeToggleBtn" onclick="togglePopupMode()" class="btn-live-toggle">LIVE MODE: OFF</button>
                <button onclick="closeFloatingPopup()" class="text-gray-400 hover:text-white transition-colors p-1 popup-close-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 close-btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
        <div id="popupBody">
            <div id="popupContentContainer" class="w-full h-full flex items-center justify-center text-gray-400 text-sm" data-i18n="noData">
                No Data.
            </div>
        </div>
    </div>

    <script>
        const MAX_HISTORY = 10;
        
        let refreshTimerId = null;
        let nextRefreshTime = 0;
        const REFRESH_INTERVAL_MS = 10 * 60 * 1000;

        let currentData = null;
        let isLiveMode = false;

        // URL„Éë„É©„É°„Éº„Çø„Åß„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„É¢„Éº„ÉâÂà§ÂÆö
        const urlParams = new URLSearchParams(window.location.search);
        const isPopupWindow = urlParams.get('mode') === 'popup';
        // „Éá„Éº„ÇøÂêåÊúüÁî®„ÅÆ„ÉÅ„É£„Éç„É´
        const broadcastChannel = new BroadcastChannel('lol_rank_monitor_channel');

        if (isPopupWindow) {
            document.body.classList.add('popup-window-mode');
            // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„É¢„Éº„Éâ„Å™„ÇâÂàùÊúüÁä∂ÊÖã„ÅßË°®Á§∫
            document.getElementById('floatingPopup').classList.remove('hidden');
        }

        const i18n = {
            ja: {
                appTitle: "LoL„É©„É≥„ÇØ„ÉÅ„Çß„ÉÉ„Ç´„Éº",
                appSubtitle: "„Çµ„É¢„Éä„ÉºÊà¶Á∏æÂàÜÊûê",
                lblGameName: "„Çµ„É¢„Éä„ÉºÂêç",
                lblTagLine: "„Çø„Ç∞„É©„Ç§„É≥",
                phGameName: "„Çµ„É¢„Éä„ÉºÂêç",
                phTagLine: "#„Çø„Ç∞",
                lblRegion: "„Çµ„Éº„Éê„Éº",
                lblHistory: "ÊúÄËøë„ÅÆÊ§úÁ¥¢",
                lblAutoRefresh: "„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éª„É¢„Éã„Çø„É™„É≥„Ç∞ (10ÂàÜ)",
                btnSearch: "Êà¶Á∏æ„ÇíÂèñÂæó„Åô„Çã",
                btnPopup: "„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅßÈñã„Åè",
                progressTitle: "„Éá„Éº„Çø„ÇíÂàÜÊûê‰∏≠...",
                stepIdentity: "„Ç¢„Ç´„Ç¶„É≥„ÉàÁâπÂÆö (PUUID)",
                stepRank: "ÁèæÂú®„ÅÆ„É©„É≥„ÇØ„Å®LP„ÇíÂèñÂæó",
                stepMatches: "Áõ¥Ëøë20Êà¶„ÅÆ„É©„É≥„ÇØÊà¶„Çí„Çπ„Ç≠„É£„É≥",
                lblRecentResults: "Áõ¥Ëøë20Êà¶„ÅÆÁµêÊûú",
                lblWins: "ÂãùÂà©",
                lblLosses: "ÊïóÂåó",
                lblWinRate: "ÂãùÁéá",
                lblSeasonTotal: "‰ªä„Ç∑„Éº„Ç∫„É≥„ÅÆÈÄöÁÆóÊàêÁ∏æ",
                alertServerRequired: "„ÄêÈáçË¶Å„Äë\n„Åì„ÅÆ„Ç¢„Éó„É™„ÅØAPI„Éó„É≠„Ç≠„Ç∑„Çí‰ΩøÁî®„Åô„Çã„Åü„ÇÅ„ÄÅWeb„Çµ„Éº„Éê„Éº‰∏ä„ÅßÂãï‰Ωú„Åï„Åõ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\nVercelÁ≠â„Å´„Éá„Éó„É≠„Ç§„Åô„Çã„Åã„ÄÅ„É≠„Éº„Ç´„É´„Çµ„Éº„Éê„Éº(localhost)ÁµåÁî±„ÅßÈñã„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\nÁõ¥Êé•HTML„Éï„Ç°„Ç§„É´„ÇíÈñã„Åè„Å®APIÈÄö‰ø°„ÅåÂãï‰Ωú„Åó„Åæ„Åõ„Çì„ÄÇ",
                popupTitle: "„É©„É≥„ÇØ„É¢„Éã„Çø„Éº",
                liveModeOn: "„É©„Ç§„Éñ„É¢„Éº„Éâ: ON",
                liveModeOff: "„É©„Ç§„Éñ„É¢„Éº„Éâ: OFF",
                noData: "„Éá„Éº„Çø„Å™„Åó",
                footerText: "Data provided by Riot Games API via Vercel Serverless Proxy.",
                errRateLimit: "„É¨„Éº„ÉàÂà∂Èôê„ÇíË∂Ö„Åà„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ",
                errApiKey: "API„Ç≠„Éº„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇ",
                errNotFound: "„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì (404)„ÄÇ",
                alertFetchFirst: "ÂÖà„Å´Êà¶Á∏æ„ÇíÂèñÂæó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                regJp: "Êó•Êú¨ (JP)",
                regNa: "ÂåóÁ±≥ (NA)",
                regEuw: "Ë•øÊ¨ß (EUW)",
                regKr: "ÈüìÂõΩ (KR)"
            },
            en: {
                appTitle: "LoL Rank Checker",
                appSubtitle: "Summoner Analytics",
                lblGameName: "Game Name",
                lblTagLine: "Tag Line (No #)",
                phGameName: "Game Name",
                phTagLine: "#Tag",
                lblRegion: "Region",
                lblHistory: "Recent Searches",
                lblAutoRefresh: "Active Monitoring (10m)",
                btnSearch: "Fetch Stats",
                btnPopup: "Open Popup Window",
                progressTitle: "Analyzing Data...",
                stepIdentity: "Verify Identity (PUUID)",
                stepRank: "Check Rank Tier & LP",
                stepMatches: "Scan Last 20 Ranked Matches",
                lblRecentResults: "Last 20 Matches Results",
                lblWins: "WINS",
                lblLosses: "LOSSES",
                lblWinRate: "WIN RATE",
                lblSeasonTotal: "SEASON TOTAL",
                alertServerRequired: "IMPORTANT:\nThis app uses an API proxy and must be run on a web server.\nPlease deploy to Vercel or open via localhost.\nAPI calls will not work if you open the HTML file directly.",
                popupTitle: "RANK MONITOR",
                liveModeOn: "LIVE MODE: ON",
                liveModeOff: "LIVE MODE: OFF",
                noData: "No Data.",
                footerText: "Data provided by Riot Games API via Vercel Serverless Proxy.",
                errRateLimit: "Rate limit exceeded. Please wait a moment.",
                errApiKey: "API Key Invalid (Server Check Required).",
                errNotFound: "Data Not Found (404).",
                alertFetchFirst: "Please fetch stats first.",
                regJp: "Japan (JP)",
                regNa: "North America (NA)",
                regEuw: "Europe West (EUW)",
                regKr: "Korea (KR)"
            },
            ko: {
                appTitle: "LoL Îû≠ÌÅ¨ Ï≤¥Ïª§",
                appSubtitle: "ÏÜåÌôòÏÇ¨ Ï†ÑÏ†Å Î∂ÑÏÑù",
                lblGameName: "ÏÜåÌôòÏÇ¨ Ïù¥Î¶Ñ",
                lblTagLine: "ÌÉúÍ∑∏",
                phGameName: "ÏÜåÌôòÏÇ¨ Ïù¥Î¶Ñ",
                phTagLine: "#ÌÉúÍ∑∏",
                lblRegion: "ÏßÄÏó≠",
                lblHistory: "ÏµúÍ∑º Í≤ÄÏÉâ",
                lblAutoRefresh: "Ïï°Ìã∞Î∏å Î™®ÎãàÌÑ∞ÎßÅ (10Î∂Ñ)",
                btnSearch: "Ï†ÑÏ†Å Í≤ÄÏÉâ",
                btnPopup: "ÌåùÏóÖ Ïó¥Í∏∞",
                progressTitle: "Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Ï§ë...",
                stepIdentity: "Í≥ÑÏ†ï ÌôïÏù∏ (PUUID)",
                stepRank: "Îû≠ÌÅ¨ Î∞è LP ÌôïÏù∏",
                stepMatches: "ÏµúÍ∑º 20Í≤ΩÍ∏∞ Ïä§Ï∫î",
                lblRecentResults: "ÏµúÍ∑º 20Í≤ΩÍ∏∞ Í≤∞Í≥º",
                lblWins: "ÏäπÎ¶¨",
                lblLosses: "Ìå®Î∞∞",
                lblWinRate: "ÏäπÎ•†",
                lblSeasonTotal: "ÏãúÏ¶å Ï†ÑÏ≤¥ ÏÑ±Ï†Å",
                alertServerRequired: "„ÄêÏ§ëÏöî„Äë\nÏù¥ Ïï±ÏùÄ API ÌîÑÎ°ùÏãúÎ•º ÏÇ¨Ïö©ÌïòÎØÄÎ°ú Ïõπ ÏÑúÎ≤ÑÏóêÏÑú Ïã§ÌñâÌï¥Ïïº Ìï©ÎãàÎã§.\nVercel Îì±Ïóê Î∞∞Ìè¨ÌïòÍ±∞ÎÇò Î°úÏª¨ ÏÑúÎ≤Ñ(localhost)Î•º ÌÜµÌï¥ Ïó¨ÏÑ∏Ïöî.\nHTML ÌååÏùºÏùÑ ÏßÅÏ†ë Ïó¥Î©¥ API ÌÜµÏã†Ïù¥ ÏûëÎèôÌïòÏßÄ ÏïäÏäµÎãàÎã§.",
                popupTitle: "Îû≠ÌÅ¨ Î™®ÎãàÌÑ∞",
                liveModeOn: "ÎùºÏù¥Î∏å Î™®Îìú: ON",
                liveModeOff: "ÎùºÏù¥Î∏å Î™®Îìú: OFF",
                noData: "Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå",
                footerText: "Data provided by Riot Games API via Vercel Serverless Proxy.",
                errRateLimit: "ÏöîÏ≤≠ Ï†úÌïú Ï¥àÍ≥º. Ïû†Ïãú Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.",
                errApiKey: "API ÌÇ§Í∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏäµÎãàÎã§.",
                errNotFound: "Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§ (404).",
                alertFetchFirst: "Î®ºÏ†Ä Ï†ÑÏ†ÅÏùÑ Í≤ÄÏÉâÌï¥Ï£ºÏÑ∏Ïöî.",
                regJp: "ÏùºÎ≥∏ (JP)",
                regNa: "Î∂ÅÎØ∏ (NA)",
                regEuw: "ÏÑúÏú†ÎüΩ (EUW)",
                regKr: "ÌïúÍµ≠ (KR)"
            },
            zh: {
                appTitle: "LoL ÊÆµ‰ΩçÊü•ËØ¢Âô®",
                appSubtitle: "Âè¨Âî§Â∏àÊï∞ÊçÆÂàÜÊûê",
                lblGameName: "Ê∏∏ÊàèÂêçÁß∞",
                lblTagLine: "Ê†áÁ≠æ",
                phGameName: "Ê∏∏ÊàèÂêçÁß∞",
                phTagLine: "#Ê†áÁ≠æ",
                lblRegion: "ÊúçÂä°Âô®",
                lblHistory: "ÊúÄËøëÊêúÁ¥¢",
                lblAutoRefresh: "‰∏ªÂä®ÁõëÊéß (10ÂàÜÈíü)",
                btnSearch: "Êü•ËØ¢ÊàòÁª©",
                btnPopup: "ÊÇ¨ÊµÆÁ™óÊòæÁ§∫",
                progressTitle: "Ê≠£Âú®ÂàÜÊûêÊï∞ÊçÆ...",
                stepIdentity: "È™åËØÅË∫´‰ªΩ (PUUID)",
                stepRank: "Ëé∑ÂèñÊÆµ‰Ωç‰∏éËÉúÁÇπ",
                stepMatches: "Êâ´ÊèèÊúÄËøë20Âú∫Êéí‰Ωç",
                lblRecentResults: "ÊúÄËøë20Âú∫ÊàòÁª©",
                lblWins: "ËÉú",
                lblLosses: "Ë¥ü",
                lblWinRate: "ËÉúÁéá",
                lblSeasonTotal: "Êú¨ËµõÂ≠£ÊÄªÊàêÁª©",
                alertServerRequired: "„ÄêÈáçË¶Å„Äë\nÊú¨Â∫îÁî®‰ΩøÁî®API‰ª£ÁêÜÔºåÂøÖÈ°ªÂú®WebÊúçÂä°Âô®‰∏äËøêË°å„ÄÇ\nËØ∑ÈÉ®ÁΩ≤Âà∞VercelÊàñÈÄöËøáÊú¨Âú∞ÊúçÂä°Âô®(localhost)ÊâìÂºÄ„ÄÇ\nÁõ¥Êé•ÊâìÂºÄHTMLÊñá‰ª∂Â∞ÜÂØºËá¥APIÈÄö‰ø°Êó†Ê≥ïÂ∑•‰Ωú„ÄÇ",
                popupTitle: "ÊÆµ‰ΩçÁõëÊéß",
                liveModeOn: "ÂÆûÊó∂Ê®°Âºè: ÂºÄ",
                liveModeOff: "ÂÆûÊó∂Ê®°Âºè: ÂÖ≥",
                noData: "ÊöÇÊó†Êï∞ÊçÆ",
                footerText: "Data provided by Riot Games API via Vercel Serverless Proxy.",
                errRateLimit: "ËØ∑Ê±ÇËøá‰∫éÈ¢ëÁπÅÔºåËØ∑Á®çÂÄô„ÄÇ",
                errApiKey: "APIÂØÜÈí•Êó†Êïà„ÄÇ",
                errNotFound: "Êú™ÊâæÂà∞Êï∞ÊçÆ (404)„ÄÇ",
                alertFetchFirst: "ËØ∑ÂÖàÊü•ËØ¢ÊàòÁ∏æ„ÄÇ",
                regJp: "Êó•Êú¨ (JP)",
                regNa: "ÂåóÁæé (NA)",
                regEuw: "Ë•øÊ¨ß (EUW)",
                regKr: "Èü©ÂõΩ (KR)"
            }
        };

        const regionNames = {
            'jp1': 'regJp',
            'na1': 'regNa',
            'euw1': 'regEuw',
            'kr': 'regKr'
        };

        function adjustAppScale() {
            // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Ç¶„Ç£„É≥„Éâ„Ç¶„É¢„Éº„Éâ„Åß„ÅØCSS„ÅÆContainer Queries„ÅåËá™ÂãïÁöÑ„Å´„Çπ„Ç±„Éº„É™„É≥„Ç∞„ÇíË°å„ÅÜ„Åü„ÇÅ„ÄÅ
            // JS„Å´„Çà„ÇãÂº∑Âà∂„Éà„É©„É≥„Çπ„Éï„Ç©„Éº„É†„ÅØ„É°„Ç§„É≥ÁîªÈù¢„ÅÆ„ÅøÈÅ©Áî®„Åô„Çã
            if (isPopupWindow) return;

            const wrapper = document.getElementById('app-scale-wrapper');
            const baseWidth = 1280;
            const baseHeight = 800;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const scaleX = windowWidth / baseWidth;
            const scaleY = windowHeight / baseHeight;
            const scale = Math.min(scaleX, scaleY); 
            wrapper.style.transform = `scale(${scale})`;
        }
        
        window.addEventListener('resize', adjustAppScale);

        document.addEventListener('DOMContentLoaded', () => {
            if (!isPopupWindow && window.location.protocol === 'file:') {
                alert(t('alertServerRequired'));
            }
            
            if (isPopupWindow) {
                // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„É¢„Éº„ÉâÂàùÊúüÂåñ
                initPopupMode();
            } else {
                renderHistory();
                changeLanguage();
                initDraggable();
                adjustAppScale();
            }
        });
        
        function initPopupMode() {
            // URL„Éë„É©„É°„Éº„Çø„Åã„ÇâliveÂÄ§„ÇíÊúÄÂÑ™ÂÖà„ÅßÂèñÂæó
            const urlLiveParam = urlParams.get('live');
            
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâÂàùÊúü„Éá„Éº„ÇøÂèñÂæó
            const syncedData = localStorage.getItem('lol_rank_sync_data');
            if (syncedData) {
                try {
                    const parsed = JSON.parse(syncedData);
                    currentData = parsed.data;
                    
                    // URL„Éë„É©„É°„Éº„Çø„Åå„ÅÇ„Çå„Å∞„Åù„Çå„ÇíÂÑ™ÂÖà„Åó„Å¶„É¢„Éº„ÉâÊ±∫ÂÆö„ÄÅ„Å™„Åë„Çå„Å∞„Çπ„Éà„É¨„Éº„Ç∏„ÅÆÂÄ§
                    if (urlLiveParam !== null) {
                        isLiveMode = (urlLiveParam === '1');
                    } else {
                        isLiveMode = parsed.isLiveMode;
                    }

                    const lang = parsed.lang || 'ja';
                    document.getElementById('langSelect').value = lang;
                    changeLanguage();
                    updateModeBtn(); // „Éú„Çø„É≥Ë°®Á§∫Êõ¥Êñ∞
                    renderPopupContent();
                    
                    // ÂàùÊúü„É™„Çµ„Ç§„Ç∫
                    try {
                        if (isLiveMode) window.resizeTo(866, 210);
                        else window.resizeTo(436, 396);
                    } catch(e) {}
                } catch(e) { console.error(e); }
            }

            // „É°„Ç§„É≥„Ç¶„Ç£„É≥„Éâ„Ç¶„Åã„Çâ„ÅÆ„Éá„Éº„ÇøÂèó‰ø°
            broadcastChannel.onmessage = (event) => {
                if (event.data.type === 'updateData') {
                    currentData = event.data.payload;
                    renderPopupContent();
                } else if (event.data.type === 'changeMode') {
                    isLiveMode = event.data.isLiveMode;
                    updateModeBtn();
                    renderPopupContent();
                    // „Ç¶„Ç£„É≥„Éâ„Ç¶„Çµ„Ç§„Ç∫„ÇÇÂêà„Çè„Åõ„Åü„ÅÑ„Å®„Åì„Çç„Å†„Åå„ÄÅ„Çª„Ç≠„É•„É™„ÉÜ„Ç£Âà∂Èôê„ÅßÂäπ„Åã„Å™„ÅÑÂ†¥Âêà„ÅåÂ§ö„ÅÑ
                    try {
                        if (isLiveMode) window.resizeTo(866, 210);
                        else window.resizeTo(436, 396);
                    } catch(e) {}
                }
            };
        }

        function t(key) {
            const lang = document.getElementById('langSelect').value;
            const texts = i18n[lang] || i18n['en'];
            return texts[key] || key;
        }

        function initDraggable() {
            if (isPopupWindow) return; // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Ç¶„Ç£„É≥„Éâ„Ç¶„Åß„ÅØ„Éâ„É©„ÉÉ„Ç∞‰∏çË¶Å
            
            const popup = document.getElementById("floatingPopup");
            const header = document.getElementById("popupHeader");
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;

            header.addEventListener("mousedown", (e) => {
                if (e.target.closest('button')) return;
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                const rect = popup.getBoundingClientRect();
                initialLeft = rect.left;
                initialTop = rect.top;
                popup.style.transform = 'none'; 
                popup.style.left = `${initialLeft}px`;
                popup.style.top = `${initialTop}px`;
                document.body.style.userSelect = "none";
            });

            document.addEventListener("mousemove", (e) => {
                if (!isDragging) return;
                popup.style.left = `${initialLeft + (e.clientX - startX)}px`;
                popup.style.top = `${initialTop + (e.clientY - startY)}px`;
            });

            document.addEventListener("mouseup", () => {
                isDragging = false;
                document.body.style.userSelect = "auto";
            });
        }

        function changeLanguage() {
            const lang = document.getElementById('langSelect').value;
            const texts = i18n[lang] || i18n['en'];
            document.documentElement.lang = lang;
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (texts[key]) el.innerText = texts[key];
            });

            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (texts[key]) el.placeholder = texts[key];
            });

            // Region Options
            const regionSelect = document.getElementById('region');
            Array.from(regionSelect.options).forEach(opt => {
                const key = regionNames[opt.value];
                if (key && texts[key]) {
                    opt.text = texts[key];
                }
            });

            updateModeBtn();
        }

        function saveToHistory(name, tag, region) {
            let history = JSON.parse(localStorage.getItem('lol_search_history') || '[]');
            
            const existingIndex = history.findIndex(item => 
                item.name.toLowerCase() === name.toLowerCase() && 
                item.tag.toLowerCase() === tag.toLowerCase()
            );
            
            let isFavorite = false;
            if (existingIndex !== -1) {
                isFavorite = history[existingIndex].isFavorite || false;
                history.splice(existingIndex, 1);
            }

            const newItem = { name, tag, region, isFavorite };

            const favorites = history.filter(item => item.isFavorite);
            const regulars = history.filter(item => !item.isFavorite);

            if (isFavorite) {
                favorites.unshift(newItem);
            } else {
                regulars.unshift(newItem);
            }

            if (regulars.length > MAX_HISTORY) {
                regulars = regulars.slice(0, MAX_HISTORY);
            }

            history = [...favorites, ...regulars];
            localStorage.setItem('lol_search_history', JSON.stringify(history));
            renderHistory();
        }

        function toggleFavorite(name, tag, event) {
            if (event) event.stopPropagation();
            let history = JSON.parse(localStorage.getItem('lol_search_history') || '[]');
            const index = history.findIndex(item => 
                item.name === name && item.tag === tag
            );

            if (index !== -1) {
                history[index].isFavorite = !history[index].isFavorite;
                
                const item = history[index];
                history.splice(index, 1);
                
                const favorites = history.filter(i => i.isFavorite);
                const regulars = history.filter(i => !i.isFavorite);
                
                if (item.isFavorite) {
                    favorites.unshift(item);
                } else {
                    regulars.unshift(item);
                }
                
                if (regulars.length > MAX_HISTORY) {
                    regulars = regulars.slice(0, MAX_HISTORY);
                }
                
                history = [...favorites, ...regulars];
                localStorage.setItem('lol_search_history', JSON.stringify(history));
                renderHistory();
            }
        }

        function removeFromHistory(name, tag, event) {
            if (event) event.stopPropagation();
            let history = JSON.parse(localStorage.getItem('lol_search_history') || '[]');
            history = history.filter(item => !(item.name === name && item.tag === tag));
            localStorage.setItem('lol_search_history', JSON.stringify(history));
            renderHistory();
        }

        function applyHistory(name, tag, region) {
            document.getElementById('gameName').value = name;
            document.getElementById('tagLine').value = tag;
            document.getElementById('region').value = region;
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('lol_search_history') || '[]');
            const container = document.getElementById('historyContainer');
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            if (history.length === 0) { container.classList.add('hidden'); return; }
            container.classList.remove('hidden');
            
            history.forEach(item => {
                const chip = document.createElement('div');
                chip.className = 'history-chip text-[10px] text-blue-200 rounded-full';
                const nameEsc = item.name.replace(/'/g, "\\'");
                const tagEsc = item.tag.replace(/'/g, "\\'");
                const regionEsc = item.region;
                const isFav = item.isFavorite;

                const starSvg = isFav 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401z" clip-rule="evenodd" /></svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>`;

                chip.innerHTML = `
                    <div class="favorite-btn ${isFav ? 'active' : ''}" onclick="toggleFavorite('${nameEsc}', '${tagEsc}', event)">
                        ${starSvg}
                    </div>
                    <div class="history-content" onclick="applyHistory('${nameEsc}', '${tagEsc}', '${regionEsc}')">
                        <span>${item.name}</span>
                        <span class="text-gray-500">#${item.tag}</span>
                    </div>
                    <div class="history-delete-btn" onclick="removeFromHistory('${nameEsc}', '${tagEsc}', event)">‚úï</div>
                `;
                list.appendChild(chip);
            });
        }

        function toggleAutoRefresh() {
            const isChecked = document.getElementById('autoRefreshToggle').checked;
            const timerLabel = document.getElementById('timerLabel');

            if (isChecked) {
                nextRefreshTime = Date.now() + REFRESH_INTERVAL_MS;
                refreshTimerId = setInterval(updateTimerAndFetch, 1000);
                updateTimerAndFetch(); 
                timerLabel.classList.remove('hidden');
            } else {
                if (refreshTimerId) { clearInterval(refreshTimerId); refreshTimerId = null; }
                timerLabel.classList.add('hidden');
                timerLabel.innerText = '';
            }
        }

        async function checkStatusAndRefresh() {
            if (!currentData || !currentData.account) return;
            const puuid = currentData.account.puuid;
            const region = document.getElementById('region').value;

            try {
                // 1. Ë©¶Âêà‰∏≠Âà§ÂÆö
                try {
                    await fetchWithRetry(`https://${region}.api.riotgames.com/lol/spectator/v5/active-games/by-summoner/${puuid}`);
                    // ÊàêÂäü(200) = Ë©¶Âêà‰∏≠
                    console.log("[Monitor] Player is currently in game. Skipping refresh.");
                    return; 
                } catch (e) {
                    // 404‰ª•Â§ñ„ÅØ„Ç®„É©„Éº„Å®„Åó„Å¶‰∏≠Êñ≠„Åô„Çã„Åå„ÄÅ404ÔºàË©¶Âêà‰∏≠„Åß„ÅØ„Å™„ÅÑÔºâ„Å™„ÇâÊ¨°„Å∏
                    if (e.message.indexOf('404') === -1 && e.message.indexOf(t('errNotFound')) === -1) {
                        throw e;
                    }
                }

                // 2. LPÂ§âÂãïÁ¢∫Ë™ç
                const leagueData = await fetchWithRetry(`https://${region}.api.riotgames.com/lol/league/v4/entries/by-puuid/${puuid}`);
                const soloRank = leagueData.find(entry => entry.queueType === "RANKED_SOLO_5x5");
                const currentLP = soloRank ? soloRank.leaguePoints : 0;
                const currentTier = soloRank ? soloRank.tier : "UNRANKED";

                // ÁîªÈù¢‰∏ä„ÅÆ„Éá„Éº„Çø„Å®ÊØîËºÉ (currentData„ÅØÂÖ®„Éá„Éº„ÇøÊõ¥Êñ∞ÊôÇ„Å´„Çª„ÉÉ„Éà„Åï„Çå„Çã)
                if (currentLP !== currentData.lp || currentTier !== currentData.tier) {
                    console.log("[Monitor] Rank/LP change detected. Starting full fetch.");
                    await startFetch(true);
                } else {
                    console.log("[Monitor] No LP change. Skipping full refresh.");
                }
            } catch (err) {
                console.error("[Monitor] Error during checkStatusAndRefresh:", err);
            }
        }

        function updateTimerAndFetch() {
            const now = Date.now();
            const diff = nextRefreshTime - now;

            if (diff <= 0) {
                checkStatusAndRefresh();
                nextRefreshTime = now + REFRESH_INTERVAL_MS;
                const m = Math.floor(REFRESH_INTERVAL_MS / 60000);
                document.getElementById('timerLabel').innerText = `(${m}:00)`;
            } else {
                const m = Math.floor(diff / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                document.getElementById('timerLabel').innerText = `(${m}:${s.toString().padStart(2, '0')})`;
            }
        }

        function toggleFloatingPopup() {
            // OBS„Ç¶„Ç£„É≥„Éâ„Ç¶„Ç≠„É£„Éó„ÉÅ„É£ÂØæÂøú„ÅÆ„Åü„ÇÅ„ÄÅÂà•„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅßÈñã„Åè„Çà„ÅÜ„Å´Â§âÊõ¥
            if (!currentData) { 
                alert(t('alertFetchFirst')); 
                return; 
            }

            // „Çµ„Ç§„Ç∫Ë™øÊï¥: LIVE„É¢„Éº„Éâ2.5ÂÄç„ÄÅÈÄöÂ∏∏„É¢„Éº„Éâ1.5ÂÄç
            // LIVE„É¢„Éº„Éâ„ÅØÂπÖ„ÇíÂ∫É„Åí„Åô„Åé„Åö„ÄÅÈÅ©Â∫¶„Å™ÂπÖ„Å´Ë™øÊï¥
            const width = isLiveMode ? 850 : 420;
            const height = isLiveMode ? 160 : 336;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            
            // ÁèæÂú®„ÅÆ„Éá„Éº„Çø„ÇíÂêåÊúüÁî®„Å´‰øùÂ≠ò
            localStorage.setItem('lol_rank_sync_data', JSON.stringify({
                data: currentData,
                isLiveMode: isLiveMode,
                lang: document.getElementById('langSelect').value
            }));

            // Êñ∞„Åó„ÅÑ„Ç¶„Ç£„É≥„Éâ„Ç¶„ÇíÈñã„Åè
            // live„Éë„É©„É°„Éº„Çø„Çí‰ªò‰∏é„Åó„Å¶„ÄÅÈñã„ÅÑ„ÅüÁû¨Èñì„ÅÆ„É¢„Éº„Éâ„ÇíÁ¢∫ÂÆö„Åï„Åõ„Çã
            const liveParam = isLiveMode ? '1' : '0';
            
            window.open(
                `${window.location.pathname}?mode=popup&live=${liveParam}`, 
                'RankMonitorPopup', 
                `width=${width},height=${height},left=${left},top=${top},menubar=no,toolbar=no,location=no,status=no,resizable=yes,scrollbars=no`
            );
        }

        function closeFloatingPopup() {
            if (isPopupWindow) {
                window.close();
            } else {
                document.getElementById('floatingPopup').classList.add('hidden');
            }
        }

        function togglePopupMode() {
            isLiveMode = !isLiveMode;
            updateModeBtn();
            
            // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅÆ„Çµ„Ç§„Ç∫Â§âÊõ¥„ÅØOS/„Éñ„É©„Ç¶„Ç∂Âà∂Èôê„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅ
            // „Ç¶„Ç£„É≥„Éâ„Ç¶ÂÜÖ„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑË™øÊï¥„ÅÆ„ÅøË°å„ÅÜÔºàContainer Queries„Åå„Çµ„Ç§„Ç∫„Å´ËøΩÂæì„Åô„ÇãÔºâ
            const popup = document.getElementById('floatingPopup');
            if (!isPopupWindow) {
                // ÈÄöÂ∏∏„É¢„Éº„ÉâÂÜÖ„ÅÆ„Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅÆ„Çµ„Ç§„Ç∫Ë™øÊï¥
                if (isLiveMode) {
                    popup.style.width = '850px';
                    popup.style.height = '160px';
                } else {
                    popup.style.width = '420px';
                    popup.style.height = '336px';
                }
            } else {
                // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Ç¶„Ç£„É≥„Éâ„Ç¶„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÄÅ„Ç¶„Ç£„É≥„Éâ„Ç¶„Çµ„Ç§„Ç∫Â§âÊõ¥„ÇíË©¶„Åø„Çã
                try {
                    // Êû†ÂàÜ„ÇíÈÅ©ÂΩì„Å´ËÄÉÊÖÆ
                    if (isLiveMode) window.resizeTo(866, 210);
                    else window.resizeTo(436, 396);
                } catch(e) {
                    console.log('Window resize blocked by browser');
                }
            }
            
            renderPopupContent();

            // „É¢„Éº„ÉâÂ§âÊõ¥„Çí‰ªñÊñπ„ÅÆ„Ç¶„Ç£„É≥„Éâ„Ç¶„Å´ÈÄöÁü•
            broadcastChannel.postMessage({
                type: 'changeMode',
                isLiveMode: isLiveMode
            });
        }

        function updateModeBtn() {
            const btn = document.getElementById('modeToggleBtn');
            if (isLiveMode) {
                btn.innerText = t('liveModeOn');
                btn.classList.add('active-mode');
            } else {
                btn.innerText = t('liveModeOff');
                btn.classList.remove('active-mode');
            }
        }

        function renderPopupContent() {
            if (!currentData) return;
            const container = document.getElementById('popupContentContainer');
            const { tier, rank, lp, wins, losses, history } = currentData;
            
            let rankImgHtml = '';
            if (tier !== "UNRANKED") {
                let imgName = (tier === "IRON") ? "Iron.png" : `${tier.toLowerCase()}.png`;
                rankImgHtml = `<img src="png/${imgName}" class="cq-rank-icon" alt="${tier}">`;
            }
            const color = getTierColor(tier);

            if (isLiveMode) {
                let historyHtml = '';
                if (history && history.length > 0) {
                    historyHtml = `<div class="history-bar">`;
                    history.forEach((isWin, index) => {
                        const className = isWin ? 'block-win' : 'block-loss';
                        historyHtml += `<div class="history-block ${className}"></div>`;
                        // ÊúÄÂæå„ÅÆË¶ÅÁ¥†‰ª•Â§ñ„Å´„Çπ„Éö„Éº„Çµ„Éº„ÇíËøΩÂä†
                        if (index < history.length - 1) {
                            historyHtml += `<div class="history-spacer"></div>`;
                        }
                    });
                    historyHtml += `</div>`;
                }

                container.innerHTML = `
                    <div class="cq-container layout-live">
                        ${rankImgHtml}
                        <div class="cq-content">
                            <div class="cq-rank-row">
                                <div class="cq-rank-text" style="color: ${color}">${tier} ${rank}</div>
                                <div class="cq-lp-text" style="color: ${color}">${lp} LP</div>
                            </div>
                            <div class="cq-stats-row">
                                <div class="cq-stat-item">
                                    <div class="cq-stat-label" style="color: #60a5fa">W</div>
                                    <div class="cq-stat-value">${wins}</div>
                                </div>
                                <div class="cq-stat-item">
                                    <div class="cq-stat-label" style="color: #f87171">L</div>
                                    <div class="cq-stat-value">${losses}</div>
                                </div>
                                ${historyHtml}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="cq-container layout-normal">
                        <div class="section-icon">
                            ${rankImgHtml}
                        </div>
                        <div class="section-info">
                            <div class="cq-rank-text" style="color: ${color}">${tier} ${rank}</div>
                            <div class="cq-lp-text" style="color: ${color}">${lp} LP</div>
                            <div class="cq-stats-group">
                                <div class="cq-stat-item">
                                    <div class="cq-stat-label" style="color: #60a5fa">W</div>
                                    <div class="cq-stat-value">${wins}</div>
                                </div>
                                <div class="cq-stat-item">
                                    <div class="cq-stat-label" style="color: #f87171">L</div>
                                    <div class="cq-stat-value">${losses}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        async function startFetch(isAutoRefresh = false) {
            const nameInput = document.getElementById('gameName').value.trim();
            const tagInput = document.getElementById('tagLine').value.trim().replace('#', '');
            const region = document.getElementById('region').value;

            if (!nameInput || !tagInput) return;

            if (!isAutoRefresh) {
                document.getElementById('fetchProgress').classList.remove('hidden');
                document.getElementById('resultArea').classList.add('hidden');
                document.getElementById('errorMsg').classList.add('hidden');
                resetSteps();
                saveToHistory(nameInput, tagInput, region);
            }

            try {
                let route = "asia";
                if (["na1", "br1", "la1", "la2"].includes(region)) route = "americas";
                if (["euw1", "eun1", "tr1", "ru"].includes(region)) route = "europe";

                // Step 1: Verify Identity (PUUID)
                updateStepUI('step-account', 'loading');
                const accountData = await fetchWithRetry(`https://${route}.api.riotgames.com/riot/account/v1/accounts/by-riot-id/${encodeURIComponent(nameInput)}/${encodeURIComponent(tagInput)}`);
                updateStepUI('step-account', 'success');

                // Step 2 & 3: Parallel Execution (Rank Info & Matches)
                updateStepUI('step-league', 'loading');
                updateStepUI('step-matches', 'loading');

                const leaguePromise = (async () => {
                    const data = await fetchWithRetry(`https://${region}.api.riotgames.com/lol/league/v4/entries/by-puuid/${accountData.puuid}`);
                    updateStepUI('step-league', 'success');
                    return data;
                })();

                const matchesPromise = (async () => {
                    const matchIds = await fetchWithRetry(`https://${route}.api.riotgames.com/lol/match/v5/matches/by-puuid/${accountData.puuid}/ids?start=0&count=20&type=ranked`);
                    
                    let wins = 0, losses = 0;
                    let history = [];
                    let processedCount = 0;

                    const matchPromises = matchIds.map(async (matchId) => {
                        try {
                            const matchData = await fetchWithRetry(`https://${route}.api.riotgames.com/lol/match/v5/matches/${matchId}`);
                            processedCount++;
                            const label = document.getElementById('matchCountLabel');
                            if(label) label.innerText = `(${processedCount} / ${matchIds.length})`;

                            if (matchData && matchData.info && matchData.info.participants) {
                                const participant = matchData.info.participants.find(p => p.puuid === accountData.puuid);
                                if (participant) { 
                                    return participant.win;
                                }
                            }
                            return null;
                        } catch (e) {
                            console.warn(`Failed to fetch match ${matchId}`, e);
                            processedCount++;
                            return null;
                        }
                    });

                    const results = await Promise.all(matchPromises);
                    
                    results.forEach(result => {
                        if (result === true) { wins++; history.push(true); }
                        else if (result === false) { losses++; history.push(false); }
                    });

                    updateStepUI('step-matches', 'success');
                    return { wins, losses, history };
                })();

                // Wait for both tasks
                const [leagueData, matchStats] = await Promise.all([leaguePromise, matchesPromise]);
                
                const soloRank = leagueData.find(entry => entry.queueType === "RANKED_SOLO_5x5");
                
                currentData = {
                    account: accountData,
                    tier: soloRank ? soloRank.tier : "UNRANKED",
                    rank: soloRank ? soloRank.rank : "",
                    lp: soloRank ? soloRank.leaguePoints : 0,
                    wins: matchStats.wins,
                    losses: matchStats.losses,
                    history: matchStats.history.slice(0, 10),
                    totalWins: soloRank ? soloRank.wins : 0,
                    totalLosses: soloRank ? soloRank.losses : 0
                };

                displayFinalResults();
                
                // „Éá„Éº„ÇøÊõ¥Êñ∞„Çí„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Å´ÈÄöÁü•
                broadcastChannel.postMessage({
                    type: 'updateData',
                    payload: currentData
                });

                // ÈÄöÂ∏∏„É¢„Éº„Éâ„Åß„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅåÊó¢„Å´Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà
                if (!document.getElementById('floatingPopup').classList.contains('hidden') && !isPopupWindow) {
                    renderPopupContent();
                }
            } catch (err) {
                showError(err.message);
            }
        }

        async function fetchWithRetry(url) {
            const path = url.replace(/^https?:\/\//, '');
            const proxiedUrl = `/api/riot/${path}`;

            try {
                const response = await fetch(proxiedUrl);
                
                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({}));
                    if (response.status === 429) throw new Error(t('errRateLimit'));
                    if (response.status === 403) throw new Error(t('errApiKey'));
                    if (response.status === 404) throw new Error(t('errNotFound'));
                    throw new Error(errorBody.error || `HTTP Error ${response.status}`);
                }
                
                return await response.json();
            } catch (err) {
                console.error("Fetch Error:", err);
                throw err;
            }
        }

        function updateStepUI(id, state) {
            const el = document.getElementById(id);
            const icon = el.querySelector('.status-icon');
            if (state === 'loading') { 
                el.classList.add('text-blue-400'); 
                el.classList.remove('text-green-400');
                icon.classList.add('loading-dots'); 
                icon.innerText = "";
            }
            else if (state === 'success') { 
                el.classList.remove('text-blue-400');
                el.classList.add('text-green-400'); 
                icon.innerText = "‚úì"; 
                icon.classList.remove('loading-dots'); 
            }
        }

        function resetSteps() {
            ['step-account', 'step-league', 'step-matches'].forEach((id, i) => {
                const el = document.getElementById(id);
                el.className = "flex items-center gap-3 text-gray-500";
                const icon = el.querySelector('.status-icon');
                icon.innerText = i + 1;
                icon.className = "w-6 h-6 rounded-full border-2 border-current flex items-center justify-center text-[10px] status-icon opacity-50";
            });
            document.getElementById('matchCountLabel').innerText = '';
        }

        function displayFinalResults() {
            const data = currentData;
            document.getElementById('resultArea').classList.remove('hidden');
            document.getElementById('fetchProgress').classList.add('hidden');
            
            document.getElementById('displayName').innerText = `${data.account.gameName} #${data.account.tagLine}`;
            document.getElementById('winCount').innerText = data.wins;
            document.getElementById('lossCount').innerText = data.losses;
            const color = getTierColor(data.tier);
            document.getElementById('rankText').innerText = `${data.tier} ${data.rank}`;
            document.getElementById('rankText').style.color = color;
            const lpEl = document.getElementById('lpValue');
            lpEl.innerText = `${data.lp} LP`;
            lpEl.style.color = color;
            lpEl.style.textShadow = '0 0 10px currentColor';
            
            const iconContainer = document.getElementById('rankIconContainer');
            if (data.tier === "UNRANKED") {
                iconContainer.classList.add('hidden');
            } else {
                iconContainer.classList.remove('hidden');
                let imgName = (data.tier === "IRON") ? "Iron.png" : `${data.tier.toLowerCase()}.png`;
                document.getElementById('rankIcon').src = `png/${imgName}`;
            }
            
            document.getElementById('totalWinCount').innerText = data.totalWins;
            document.getElementById('totalLossCount').innerText = data.totalLosses;
            const total = data.totalWins + data.totalLosses;
            document.getElementById('totalWinRatio').innerText = total > 0 ? Math.round((data.totalWins / total) * 100) + '%' : '0%';
            
            const now = new Date();
            document.getElementById('lastUpdatedLabel').innerText = `Last Updated: ${now.toLocaleTimeString()}`;
        }

        function getTierColor(tier) {
            const colors = { 'IRON': '#a19d94', 'BRONZE': '#cd7f32', 'SILVER': '#c0c0c0', 'GOLD': '#ffd700', 'PLATINUM': '#2596be', 'EMERALD': '#10b981', 'DIAMOND': '#b9f2ff', 'MASTER': '#d400ff', 'GRANDMASTER': '#ff4500', 'CHALLENGER': '#f0e68c' };
            return colors[tier] || '#ffffff';
        }

        function showError(msg) {
            document.getElementById('errorText').innerText = msg;
            document.getElementById('errorMsg').classList.remove('hidden');
            document.getElementById('fetchProgress').classList.add('hidden');
        }

        (function() {
            const originalFetch = window.fetchWithRetry;
            const RATE_LIMIT = 115;
            const TIME_WINDOW = 60000;
            const requestTimestamps = [];

            window.fetchWithRetry = async function(url) {
                const now = Date.now();
                while (requestTimestamps.length > 0 && requestTimestamps[0] <= now - TIME_WINDOW) {
                    requestTimestamps.shift();
                }

                if (requestTimestamps.length >= RATE_LIMIT) {
                    const oldestTimestamp = requestTimestamps[0];
                    const waitTime = (oldestTimestamp + TIME_WINDOW) - now + 100;
                    
                    if (waitTime > 0) {
                        console.log(`[Rate Limiter] Limit reached. Waiting ${waitTime}ms before next request...`);
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                        return window.fetchWithRetry(url);
                    }
                }

                requestTimestamps.push(Date.now());
                return originalFetch(url);
            };
            
            console.log("API Rate Limiter initialized: Max 115 req/min");
        })();
    </script>
</body>
</html>
